name: fe-pr-preview
on:
  repository_dispatch:
    types: [create-fe-pr-for-backend]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-or-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Prepare branch name
        id: br
        run: echo "name=preview/be-pr-${{ github.event.client_payload.backend_pr }}" >> $GITHUB_OUTPUT

      - name: Create/update branch & .env.preview
        env:
          BR: ${{ steps.br.outputs.name }}
          URL: ${{ github.event.client_payload.backend_url }}
        run: |
          # --- 修改點：先設定全域 Git User，確保後面所有 commit (包含 fallback) 都能吃到 ---
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # -----------------------------------------------------------------------

          git fetch origin main
          if git ls-remote --exit-code --heads origin "$BR"; then
            git checkout "$BR"
            # 嘗試 merge main，如果有 conflict 允許失敗 (或改用 reset)
            git merge --no-edit origin/main || true
          else
            git checkout -b "$BR" origin/main
          fi

          echo "VITE_API_BASE=$URL" > .env.preview
          git add .env.preview

          # 這裡現在安全了：如果第一個 commit 沒東西 (URL沒變)，
          # 第二個 empty commit 會執行，且因為上面已經 config 過 user，不會再報錯
          git commit -m "preview(api): $URL" || git commit --allow-empty -m "preview: refresh"

          git push -u origin "$BR"

      - name: Open PR to main
        uses: actions/github-script@v7
        env:
          BR: ${{ steps.br.outputs.name }}
          BE_PR: ${{ github.event.client_payload.backend_pr }}
        with:
          script: |
            const br = process.env.BR
            const bePr = process.env.BE_PR
            const { owner, repo } = context.repo

            // 先找是否已有同一 head 的開啟 PR（head 要用 owner:branch）
            const { data: prs } = await github.rest.pulls.list({
              owner, repo,
              state: 'open',
              head: `${owner}:${br}`,
              base: 'main'
            })

            if (prs.length === 0) {
              const { data: pr } = await github.rest.pulls.create({
                owner, repo,
                head: br,
                base: 'main',
                title: `FE Preview for BE PR #${bePr}`,
                body: `Backend preview for BE PR #${bePr}`
              })
              core.info(`Created PR #${pr.number}`)
            } else {
              core.info(`PR already exists: #${prs[0].number}`)
            }
